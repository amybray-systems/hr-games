<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>HR Simulator ‚Äî Mini Quarter</title>
<style>
  :root{
    --bg1:#667eea;--bg2:#764ba2;--panel:#ffffff;--ink:#222;--muted:#666;
    --ok:#2e7d32;--warn:#e65100;--risk:#c62828;--accent:#4f46e5;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    min-height:100vh;background:linear-gradient(135deg,var(--bg1),var(--bg2));
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    color:var(--ink);padding:28px 16px;display:flex;justify-content:center
  }
  .shell{width:100%;max-width:1100px}
  header{color:#fff;text-align:center;margin-bottom:18px}
  header h1{font-size:2.2rem;text-shadow:0 2px 6px rgba(0,0,0,.25)}
  header p{opacity:.95;margin-top:6px}

  .grid{display:grid;grid-template-columns:320px 1fr;gap:16px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{
    background:var(--panel);border-radius:18px;box-shadow:0 10px 28px rgba(0,0,0,.25);
    padding:18px
  }
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{border:1px solid #e5e7eb;border-radius:999px;padding:7px 12px;font-weight:700}
  .pill.bad{color:var(--risk);border-color:#ffcdd2;background:#ffebee}
  .pill.good{color:var(--ok);border-color:#c8e6c9;background:#e8f5e9}
  .controls select,.controls button{
    border:1px solid #e5e7eb;border-radius:12px;background:#fff;padding:9px 12px;font-size:.95rem;cursor:pointer
  }
  .controls button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .controls button:disabled{opacity:.6;cursor:not-allowed}

  .kpi{margin:10px 0}
  .kpi h4{font-size:.9rem;margin-bottom:6px;display:flex;justify-content:space-between}
  .bar{
    height:12px;background:#eef2ff;border-radius:999px;overflow:hidden;border:1px solid #e5e7eb
  }
  .bar > div{height:100%;background:var(--accent);width:50%;transition:width .3s}
  .bar.risk > div{background:linear-gradient(90deg,#66bb6a,#ffa000,#ef5350)}

  .money{font-variant-numeric:tabular-nums}
  .log{max-height:260px;overflow:auto;border:1px dashed #e5e7eb;border-radius:12px;padding:10px;background:#fcfcff}
  .log p{font-size:.92rem;color:#333;margin:6px 0}
  .log .week{font-weight:800;color:#4f46e5}

  .event h3{font-size:1.15rem;margin-bottom:8px}
  .event .topic{font-size:.8rem;text-transform:uppercase;letter-spacing:.06em;color:#4f46e5;margin-bottom:6px}
  .event .desc{color:#333;margin-bottom:10px;line-height:1.5}
  .choices{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .choice{border:1px solid #e5e7eb;border-radius:12px;padding:10px;background:#fff;text-align:left;cursor:pointer}
  .choice:hover{border-color:#c7d2fe;box-shadow:0 4px 12px rgba(79,70,229,.12)}
  .foot{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
  .timer{font-weight:800}
  .hint{color:var(--muted);font-size:.9rem}

  .end h2{font-size:1.4rem;margin-bottom:6px}
  .end .outcome{font-weight:800;margin:4px 0}
  .end .reason{color:#444;margin-top:6px}
  .end .btns{margin-top:12px;display:flex;gap:10px;flex-wrap:wrap}
  .small{font-size:.85rem;color:#555}

  .leader ul{list-style:none}
  .leader li{display:flex;justify-content:space-between;border-bottom:1px dashed #eee;padding:6px 0}
  .muted{opacity:.8}
</style>
</head>
<body>
<div class="shell">
  <header>
    <h1>üè¢ HR Simulator ‚Äî Mini Quarter</h1>
    <p>Balance <b>Budget</b>, <b>Compliance Risk</b>, <b>Satisfaction</b>, and <b>Productivity</b> over 8 weeks of events.</p>
  </header>

  <div class="grid">
    <!-- LEFT: Dashboard -->
    <section class="card">
      <div class="row controls" style="justify-content:space-between;margin-bottom:8px">
        <div class="row">
          <select id="difficulty">
            <option value="NORMAL">Normal</option>
            <option value="EASY">Easy</option>
            <option value="HARD">Hard</option>
          </select>
          <select id="timerMode">
            <option value="OFF">No Timer</option>
            <option value="ON">30s / event</option>
          </select>
        </div>
        <div class="row">
          <button id="start" class="primary">Start Quarter</button>
          <button id="reset">Reset</button>
        </div>
      </div>

      <div class="row" style="justify-content:space-between;margin:6px 0 10px">
        <div class="pill">üìÜ Week: <span id="week">0</span>/8</div>
        <div class="pill money">üí∞ Budget: $<span id="budget">0</span></div>
        <div class="pill">üìà Score: <span id="score">0</span></div>
      </div>

      <div class="kpi">
        <h4>Compliance Risk <span><span id="risk">30</span>/100</span></h4>
        <div class="bar risk"><div id="riskBar" style="width:30%"></div></div>
      </div>
      <div class="kpi">
        <h4>Employee Satisfaction <span><span id="sat">60</span>/100</span></h4>
        <div class="bar"><div id="satBar" style="width:60%"></div></div>
      </div>
      <div class="kpi">
        <h4>Productivity <span><span id="prod">60</span>/100</span></h4>
        <div class="bar"><div id="prodBar" style="width:60%"></div></div>
      </div>

      <div style="margin-top:12px">
        <h4 style="margin-bottom:6px">Quarter Log</h4>
        <div class="log" id="log"><p class="muted small">Events and outcomes will appear here.</p></div>
      </div>
    </section>

    <!-- RIGHT: Event / End -->
    <section class="card" id="stage">
      <div class="event" id="event">
        <div class="topic">Welcome</div>
        <h3>Plan your quarter</h3>
        <p class="desc">Choose a difficulty, then start. Each week you‚Äôll get an event with options. Keep risk ‚â§ <b>70</b>, satisfaction ‚â• <b>50</b>, productivity ‚â• <b>50</b>, and don‚Äôt let budget hit <b>$0</b>.</p>
        <div class="choices">
          <button class="choice" disabled>Options appear after you start.</button>
        </div>
        <div class="foot">
          <div class="hint">Tip: expensive choices may reduce risk or boost satisfaction.</div>
          <div class="timer">‚è±Ô∏è <span id="tick">‚Äî</span></div>
        </div>
      </div>
    </section>
  </div>

  <section class="card" style="margin-top:16px">
    <div class="leader">
      <h3>üèÜ Local High Scores</h3>
      <ul id="scores"><li class="muted small">No scores yet ‚Äî finish a quarter!</li></ul>
      <p class="muted small">Saved in your browser (localStorage).</p>
    </div>
  </section>
</div>

<script>
// =========================
// Event deck (expanded)
// Each option applies deltas to: money, risk, sat, prod.
// =========================
const EVENTS = [
  // ‚Äî‚Äî Original style events (kept) ‚Äî‚Äî
  {t:"Overtime Spike (FLSA)", d:"Support tickets surge; managers push weekend overtime.",
   o:[
    {label:"Approve OT with meal/rest reminders + OT policy refresher", dx:{money:-6000,risk:-5,sat:+4,prod:+6}},
    {label:"Cap OT strictly; push deadlines", dx:{money:-1000,risk:+4,sat:-6,prod:-4}},
    {label:"Hire temp agency help (2 wks)", dx:{money:-9000,risk:-2,sat:+2,prod:+8}}
   ]},
  {t:"I-9 Remote Hires", d:"Two remote hires start next week; managers ask to verify via video/photo.",
   o:[
    {label:"Use authorized rep program + quick training", dx:{money:-1500,risk:-8,sat:+2,prod:+2}},
    {label:"Ask them to fly in to HQ", dx:{money:-4000,risk:-2,sat:-5,prod:-2}},
    {label:"Accept photos this time to move fast", dx:{money:0,risk:+10,sat:+1,prod:+2}}
   ]},
  {t:"Manager Training Request", d:"New managers ask for a 2-hour coaching on feedback & 1:1s.",
   o:[
    {label:"Run training this week (live)", dx:{money:-2500,risk:-2,sat:+6,prod:+2}},
    {label:"Send async toolkit; live later", dx:{money:-500,risk:0,sat:+2,prod:+1}},
    {label:"Defer to next quarter", dx:{money:0,risk:+1,sat:-3,prod:-1}}
   ]},
  {t:"Vendor DPA Lapse", d:"Recruiting tool‚Äôs DPA expired. Renew now or pause usage?",
   o:[
    {label:"Immediate renewal + audit", dx:{money:-3000,risk:-10,sat:+1,prod:+1}},
    {label:"Temporary pause; switch to manual", dx:{money:-800,risk:-5,sat:-2,prod:-6}},
    {label:"Keep using; renew later", dx:{money:0,risk:+9,sat:0,prod:+2}}
   ]},
  {t:"Pay Equity Review", d:"An engineer suggests a pay compression issue.",
   o:[
    {label:"Targeted mid-cycle adjustments", dx:{money:-7000,risk:-3,sat:+6,prod:+2}},
    {label:"Collect more data; decide Q4", dx:{money:-500,risk:0,sat:-1,prod:-1}},
    {label:"No action; budget tight", dx:{money:0,risk:+4,sat:-4,prod:-1}}
   ]},
  {t:"Return-to-Office Nudge", d:"Leaders want 2 days/week in office to ‚Äòboost collaboration‚Äô.",
   o:[
    {label:"Pilot voluntary days + stipends", dx:{money:-3000,risk:-1,sat:+3,prod:+3}},
    {label:"Mandate 2 days/week immediately", dx:{money:-500,risk:+2,sat:-6,prod:+2}},
    {label:"Stay remote this quarter", dx:{money:0,risk:0,sat:+2,prod:+1}}
   ]},
  {t:"Harassment Report", d:"Bystander reports inappropriate DMs.",
   o:[
    {label:"Immediate investigation + training refresh", dx:{money:-3500,risk:-12,sat:+3,prod:-1}},
    {label:"Warn privately; monitor informally", dx:{money:-400,risk:+6,sat:-2,prod:+1}},
    {label:"No action; ‚Äòone-off‚Äô", dx:{money:0,risk:+12,sat:-5,prod:0}}
   ]},
  {t:"SaaS Seat Creep", d:"Extra HRIS/reporting seats added without approvals.",
   o:[
    {label:"Reconcile licenses; remove idle seats", dx:{money:+3000,risk:-2,sat:+1,prod:+1}},
    {label:"Keep for growth; review later", dx:{money:-1500,risk:+1,sat:0,prod:+1}},
    {label:"Cut all extras immediately", dx:{money:+4500,risk:0,sat:-2,prod:-3}}
   ]},
  {t:"Burnout Signals", d:"Pulse survey flags burnout in Ops.",
   o:[
    {label:"Workload rebalance + meeting pruning", dx:{money:-1200,risk:-2,sat:+6,prod:+3}},
    {label:"Wellness day this Friday", dx:{money:-2500,risk:0,sat:+5,prod:-1}},
    {label:"No change; send tips", dx:{money:0,risk:+2,sat:-3,prod:0}}
   ]},
  {t:"Classification Gray Area", d:"Team wants a 40hr onsite ‚Äòcontractor‚Äô.",
   o:[
    {label:"Convert to W-2 via EOR", dx:{money:-5000,risk:-10,sat:+2,prod:+2}},
    {label:"Redesign as true project SOW", dx:{money:-1500,risk:-4,sat:+1,prod:+1}},
    {label:"Proceed as 1099", dx:{money:0,risk:+10,sat:0,prod:+2}}
   ]},

  // ‚Äî‚Äî New: EOR & Global/Payroll ‚Äî‚Äî
  {t:"EOR Onboarding Surge", d:"Client wants 6 rapid W-2 hires via EOR across two states.",
   o:[
    {label:"Greenlight 6 via EOR; rush onboarding", dx:{money:-9000,risk:-6,sat:+3,prod:+4}},
    {label:"Stagger start dates; 3 now, 3 next month", dx:{money:-4500,risk:-3,sat:+1,prod:+2}},
    {label:"Push back to 1099 for speed", dx:{money:0,risk:+9,sat:0,prod:+3}}
   ]},
  {t:"Payroll Tax Deposit Cutoff", d:"ACH window is tight after late approvals.",
   o:[
    {label:"Same-day wire; confirm with payroll vendor", dx:{money:-1200,risk:-8,sat:+1,prod:0}},
    {label:"Submit ACH and hope it clears", dx:{money:0,risk:+6,sat:-1,prod:0}},
    {label:"Delay payroll one day with comms plan", dx:{money:+500,risk:+3,sat:-8,prod:-3}}
   ]},
  {t:"Timecard Rounding Policy", d:"Supervisors want 15-minute rounding to simplify.",
   o:[
    {label:"Implement 7/8 rounding + train managers", dx:{money:-800,risk:-4,sat:+1,prod:+2}},
    {label:"Keep exact minutes; auto-approve <5m variances", dx:{money:-400,risk:-2,sat:+2,prod:+1}},
    {label:"Adopt 30-minute rounding", dx:{money:+500,risk:+7,sat:-3,prod:+1}}
   ]},
  {t:"PTO Accrual Bug", d:"Accruals doubled for 40 employees last run.",
   o:[
    {label:"Immediate correction + transparent comms", dx:{money:-3000,risk:-6,sat:+2,prod:0}},
    {label:"Fix next cycle; no comms", dx:{money:0,risk:+6,sat:-3,prod:0}},
    {label:"Honor extra PTO; adjust future accruals", dx:{money:-6000,risk:-2,sat:+5,prod:+1}}
   ]},

  // ‚Äî‚Äî New: HRIS / Salesforce ‚Äî‚Äî
  {t:"HRIS Cutover Weekend", d:"You‚Äôre migrating to a new HRIS; go-live Monday.",
   o:[
    {label:"Freeze changes Fri‚ÄìMon + cutover checklist", dx:{money:-2500,risk:-8,sat:+2,prod:-1}},
    {label:"Soft cutover, parallel run 2 weeks", dx:{money:-6000,risk:-10,sat:+3,prod:-1}},
    {label:"Big-bang go-live, no freeze", dx:{money:0,risk:+9,sat:-2,prod:+2}}
   ]},
  {t:"Salesforce Permissions Drift", d:"Field-level security too open on People App.",
   o:[
    {label:"Lock down via profiles + review PSGs", dx:{money:-1200,risk:-9,sat:0,prod:-1}},
    {label:"Hide fields in page layouts only", dx:{money:-200,risk:+3,sat:0,prod:+1}},
    {label:"Add validation rules later", dx:{money:0,risk:+5,sat:0,prod:+1}}
   ]},
  {t:"Integration Failures", d:"HRIS ‚Üî Payroll nightly sync errors (email changes not flowing).",
   o:[
    {label:"Patch ETL + backfill delta", dx:{money:-2200,risk:-6,sat:+1,prod:+1}},
    {label:"Manual updates this week; fix later", dx:{money:-600,risk:+2,sat:-2,prod:-3}},
    {label:"Ignore; handle on demand", dx:{money:0,risk:+7,sat:-3,prod:-2}}
   ]},

  // ‚Äî‚Äî New: Compliance & Privacy ‚Äî‚Äî
  {t:"DSAR Clock Starts", d:"Employee requests a copy of all personal data.",
   o:[
    {label:"Use DSAR workflow; respond within SLA", dx:{money:-1000,risk:-7,sat:+2,prod:-1}},
    {label:"Send partial now; full later", dx:{money:-200,risk:+3,sat:-2,prod:0}},
    {label:"Ask why they need it first", dx:{money:0,risk:+6,sat:-2,prod:0}}
   ]},
  {t:"Background Check Adverse Action", d:"Candidate flagged; manager wants to rescind immediately.",
   o:[
    {label:"Follow pre-adverse/adverse action steps", dx:{money:-800,risk:-8,sat:+1,prod:0}},
    {label:"Rescind immediately; document later", dx:{money:0,risk:+9,sat:-2,prod:+1}},
    {label:"Proceed; ignore report as ‚Äòold‚Äô", dx:{money:+200,risk:+10,sat:-3,prod:+1}}
   ]},
  {t:"COBRA Notice Timing", d:"Offboarding batch missed COBRA notices by 10 days.",
   o:[
    {label:"Send immediately + vendor notify", dx:{money:-1500,risk:-7,sat:+1,prod:0}},
    {label:"Wait for next batch", dx:{money:+200,risk:+6,sat:-2,prod:0}},
    {label:"Skip; assume no elections", dx:{money:0,risk:+10,sat:-3,prod:0}}
   ]},
  {t:"OSHA Recordable?", d:"Warehouse injury under debate.",
   o:[
    {label:"Record & investigate; safety stand-down", dx:{money:-1800,risk:-6,sat:+2,prod:-2}},
    {label:"Monitor; record only if worsens", dx:{money:-300,risk:+2,sat:0,prod:0}},
    {label:"Don‚Äôt record; keep production moving", dx:{money:+200,risk:+7,sat:-2,prod:+2}}
   ]},
  {t:"Pay Transparency Posting", d:"Job ads missing salary ranges in CA/CO/NY.",
   o:[
    {label:"Add ranges + comp philosophy page", dx:{money:-2200,risk:-8,sat:+2,prod:+1}},
    {label:"Add ranges to new postings only", dx:{money:-600,risk:-3,sat:0,prod:+1}},
    {label:"No change this quarter", dx:{money:0,risk:+7,sat:-2,prod:+1}}
   ]},

  // ‚Äî‚Äî New: People Ops & Culture ‚Äî‚Äî
  {t:"Recognition Drought", d:"Engagement dip tied to lack of recognition.",
   o:[
    {label:"Launch Kudos sprint + small rewards", dx:{money:-2000,risk:0,sat:+6,prod:+2}},
    {label:"Manager prompts in 1:1s only", dx:{money:-300,risk:0,sat:+2,prod:+1}},
    {label:"Do nothing this quarter", dx:{money:0,risk:0,sat:-3,prod:0}}
   ]},
  {t:"Offboarding Checklist Gaps", d:"2 laptops not returned; systems access still active.",
   o:[
    {label:"Immediate IT deprovision + asset recovery", dx:{money:-900,risk:-8,sat:0,prod:0}},
    {label:"Email reminders; deprovision later", dx:{money:-200,risk:+3,sat:0,prod:0}},
    {label:"Assume they‚Äôll return items", dx:{money:0,risk:+7,sat:-1,prod:0}}
   ]},
  {t:"Benefits Open Enrollment", d:"Carrier portal blackout during final week.",
   o:[
    {label:"Extend OE + vendor call + comms plan", dx:{money:-1600,risk:-4,sat:+4,prod:0}},
    {label:"Keep dates; manual corrections later", dx:{money:-600,risk:+2,sat:-2,prod:-1}},
    {label:"Close now; no changes", dx:{money:0,risk:+6,sat:-4,prod:+1}}
   ]},
  {t:"401(k) Auto-Enroll", d:"Finance proposes turning on auto-enroll at 4% deferral.",
   o:[
    {label:"Enable with opt-out + comms & FAQs", dx:{money:-1200,risk:-2,sat:+3,prod:+1}},
    {label:"Pilot for new hires only", dx:{money:-500,risk:-1,sat:+1,prod:0}},
    {label:"Defer to next year", dx:{money:0,risk:+1,sat:-1,prod:0}}
   ]},
  {t:"Multi-State SUI Rate Change", d:"Two states increased SUI unexpectedly.",
   o:[
    {label:"Recalc & update payroll tables now", dx:{money:-3500,risk:-5,sat:+1,prod:0}},
    {label:"Adjust next quarter; track variance", dx:{money:-800,risk:+3,sat:0,prod:0}},
    {label:"Ignore; reconcile year-end", dx:{money:+500,risk:+7,sat:-2,prod:0}}
   ]},
];

/* =========================
   State & helpers
   ========================= */
const el = id=>document.getElementById(id);
const weekEl=el('week'), budgetEl=el('budget'), scoreEl=el('score');
const riskEl=el('risk'), riskBar=el('riskBar');
const satEl=el('sat'), satBar=el('satBar');
const prodEl=el('prod'), prodBar=el('prodBar');
const logEl=el('log'), stage=el('stage'), tickEl=el('tick');
const diffSel=el('difficulty'), timerSel=el('timerMode');
const btnStart=el('start'), btnReset=el('reset'), scoresList=el('scores');

const TARGETS = { maxRisk:70, minSat:50, minProd:50, minCash:1 };
const KEY="hrs_minq_scores_v1";

let state = {
  week:0, weeksTotal:8,
  money:0, risk:30, sat:60, prod:60,
  score:0, playing:false, timer:null, timeLeft:30,
  deck:[], idx:0, mult:1
};

function formatMoney(n){ return (Math.round(n)).toLocaleString(); }
function clamp(x,min,max){ return Math.max(min, Math.min(max,x)); }
function rngPick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function shuffle(a){ const x=[...a]; for(let i=x.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[x[i],x[j]]=[x[j],x[i]]} return x; }

function startQuarter(){
  // Baselines by difficulty
  const diff = diffSel.value;
  let startCash = 50000, mult = 1;
  if(diff==="EASY"){ startCash=65000; mult=1.1; }
  if(diff==="HARD"){ startCash=40000; mult=0.9; }
  state = { week:0,weeksTotal:8, money:startCash, risk:30, sat:60, prod:60, score:0, playing:true, timer:null, timeLeft:30, deck:shuffle(EVENTS), idx:0, mult };
  logEl.innerHTML = `<p class="small muted">Quarter started: <b>${diff}</b> difficulty. Starting budget $${formatMoney(startCash)}.</p>`;
  btnStart.disabled=true;
  render();
  nextWeek();
}

function resetAll(){
  if(state.timer){ clearInterval(state.timer); }
  state.playing=false; btnStart.disabled=false;
  weekEl.textContent="0"; budgetEl.textContent="0"; scoreEl.textContent="0";
  riskEl.textContent="30"; riskBar.style.width="30%";
  satEl.textContent="60"; satBar.style.width="60%";
  prodEl.textContent="60"; prodBar.style.width="60%";
  stage.innerHTML = document.getElementById('event').outerHTML; // reset content
  tickEl.textContent="‚Äî";
  logEl.innerHTML = `<p class="muted small">Events and outcomes will appear here.</p>`;
}

function render(){
  weekEl.textContent = state.week;
  budgetEl.textContent = formatMoney(state.money);
  scoreEl.textContent = state.score;
  riskEl.textContent = state.risk; riskBar.style.width = state.risk+"%";
  satEl.textContent = state.sat;   satBar.style.width  = state.sat+"%";
  prodEl.textContent= state.prod;  prodBar.style.width = state.prod+"%";
}

function log(msg, wk=null){
  const p=document.createElement('p');
  p.innerHTML = wk? `<span class="week">Week ${wk}:</span> ${msg}` : msg;
  logEl.prepend(p);
}

function nextWeek(){
  state.week++;
  if(state.week>state.weeksTotal){ return endQuarter(); }
  // draw event (cycle if needed)
  if(state.idx>=state.deck.length) state.deck = shuffle(EVENTS), state.idx=0;
  const ev = state.deck[state.idx++];

  stage.innerHTML = `
    <div class="event">
      <div class="topic">${ev.t}</div>
      <h3>Week ${state.week} Event</h3>
      <p class="desc">${ev.d}</p>
      <div class="choices">
        ${ev.o.map((c,i)=>`<button class="choice" data-i="${i}">${c.label}</button>`).join("")}
      </div>
      <div class="foot">
        <div class="hint">Aim to finish with Risk ‚â§ ${TARGETS.maxRisk}, Sat ‚â• ${TARGETS.minSat}, Prod ‚â• ${TARGETS.minProd}, Cash > $0.</div>
        <div class="timer">‚è±Ô∏è <span id="tick">${timerSel.value==="ON" ? 30 : "‚Äî"}</span></div>
      </div>
    </div>`;
  // attach handlers
  [...stage.querySelectorAll('.choice')].forEach(btn=>{
    btn.addEventListener('click', ()=>applyChoice(ev, parseInt(btn.dataset.i,10)));
  });

  // per-event timer
  if(state.timer){ clearInterval(state.timer); }
  if(timerSel.value==="ON"){
    state.timeLeft=30;
    state.timer = setInterval(()=>{
      state.timeLeft--;
      const tEl = stage.querySelector('#tick'); if(tEl) tEl.textContent = state.timeLeft;
      if(state.timeLeft<=0){
        clearInterval(state.timer);
        // auto-pick the "middle" option for neutrality-ish
        applyChoice(ev, Math.min(1, ev.o.length-1), true);
      }
    },1000);
  } else {
    stage.querySelector('#tick').textContent = "‚Äî";
  }
}

function applyChoice(ev, idx, auto=false){
  if(state.timer){ clearInterval(state.timer); }
  const opt = ev.o[idx];
  const dx = scaleDeltas(opt.dx, state.mult);
  // apply
  state.money += dx.money;
  state.risk  = clamp(state.risk + dx.risk, 0, 100);
  state.sat   = clamp(state.sat  + dx.sat , 0, 100);
  state.prod  = clamp(state.prod + dx.prod,0, 100);
  // scoring: reward low risk & strong sat/prod; penalize spend
  const kpiScore = (100-state.risk) + state.sat + state.prod;
  const spendHit = Math.max(0, -dx.money/100); // spending reduces score a bit
  state.score += Math.round( (kpiScore/10) - spendHit );

  render();
  const tag = auto? "‚è±Ô∏è Auto" : "‚úÖ";
  const moneyStr = (dx.money>=0?"+$":"-$")+formatMoney(Math.abs(dx.money));
  log(`${tag} <b>${opt.label}</b> (${moneyStr}, Risk ${fmtDelta(dx.risk)}, Sat ${fmtDelta(dx.sat)}, Prod ${fmtDelta(dx.prod)})`, state.week);

  // lose checks mid-quarter
  if(state.money <= 0){ return endQuarter("Budget depleted"); }
  if(state.risk >= 100){ return endQuarter("Risk maxed"); }

  // next week or end
  if(state.week >= state.weeksTotal){ endQuarter(); }
  else { nextWeek(); }
}

function scaleDeltas(dx, mult){
  // money is literal; other KPIs scale with diff multiplier
  return {
    money: dx.money,
    risk: Math.round(dx.risk*mult),
    sat:  Math.round(dx.sat*mult),
    prod: Math.round(dx.prod*mult),
  };
}
function fmtDelta(n){ return (n>=0?"+":"")+n; }

function endQuarter(reason=null){
  state.playing=false; btnStart.disabled=false;
  if(state.timer){ clearInterval(state.timer); }

  const passed =
    state.money >= TARGETS.minCash &&
    state.risk  <= TARGETS.maxRisk &&
    state.sat   >= TARGETS.minSat &&
    state.prod  >= TARGETS.minProd;

  const headline = passed ? "Quarter Success!" : "Quarter Missed";
  const color = passed ? "good" : "bad";
  const failReason = reason ? `<div class="reason">Ended early: <b>${reason}</b></div>` : "";

  stage.innerHTML = `
    <div class="end">
      <h2 class="${color}">${headline}</h2>
      <div class="outcome">Final Score: <b>${state.score}</b></div>
      <div class="outcome money">Budget: $${formatMoney(state.money)}</div>
      <div class="outcome">Risk: ${state.risk} | Sat: ${state.sat} | Prod: ${state.prod}</div>
      ${failReason}
      <div class="reason">Targets were Risk ‚â§ ${TARGETS.maxRisk}, Sat ‚â• ${TARGETS.minSat}, Prod ‚â• ${TARGETS.minProd}, Cash > $0.</div>
      <div class="btns">
        <button id="playAgain" class="primary">Play Again</button>
        <button id="sameDiff">Same Settings</button>
      </div>
      <p class="small muted" style="margin-top:6px">Tip: Easy gives more starting cash; Hard gives tighter KPI swings.</p>
    </div>`;
  stage.querySelector('#playAgain').addEventListener('click', startQuarter);
  stage.querySelector('#sameDiff').addEventListener('click', ()=>{ btnStart.click(); });

  // Save score
  const row = { score:state.score, money:state.money, risk:state.risk, sat:state.sat, prod:state.prod, when:new Date().toISOString(), diff:diffSel.value };
  const arr = JSON.parse(localStorage.getItem(KEY)||"[]");
  arr.push(row); arr.sort((a,b)=>b.score-a.score);
  localStorage.setItem(KEY, JSON.stringify(arr.slice(0,10)));
  renderScores();
}

function renderScores(){
  const arr = JSON.parse(localStorage.getItem(KEY)||"[]");
  scoresList.innerHTML = arr.length? "" : `<li class="muted small">No scores yet ‚Äî finish a quarter!</li>`;
  arr.forEach((r,i)=>{
    const li=document.createElement('li');
    li.innerHTML = `<span>#${i+1} ‚Ä¢ ${r.score}</span><span class="muted">${r.diff} ‚Ä¢ $${formatMoney(r.money)} ‚Ä¢ R${r.risk}/S${r.sat}/P${r.prod}</span>`;
    scoresList.appendChild(li);
  });
}

/* init */
btnStart.addEventListener('click', startQuarter);
btnReset.addEventListener('click', resetAll);
renderScores();
</script>
</body>
</html>
